<html>
    <head>
        <script src="https://www.gstatic.com/firebasejs/6.4.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/6.4.0/firebase-firestore.js"></script>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
        <script>
        var firebaseConfig = {
            apiKey: "AIzaSyC0Icjhyr_ydgYbiiZaWPy6K5yQVMgnPZY",
            authDomain: "spectre-13685.firebaseapp.com",
            databaseURL: "https://spectre-13685.firebaseio.com",
            projectId: "spectre-13685",
            storageBucket: "spectre-13685.appspot.com",
            messagingSenderId: "646451586951",
            appId: "1:646451586951:web:8c7bf899cd7ad482"
        };
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
        var userId = undefined;
        const callFunction = (fname, params, callback) => {
            const Http = new XMLHttpRequest();
            const url = 'https://asia-northeast1-spectre-13685.cloudfunctions.net/' + fname;
            Http.open("POST", url + '?' + jQuery.param(params));
            Http.onreadystatechange = (e) => {
                if(Http.readyState == 4 && Http.status == 200){
                    callback(Http);
                }
            }
            Http.send();
        }
        const registerUser = () => {
            var nn = $('#nntxt').val();
            console.log('DEBUG Nickname',nn);
            callFunction('registerUser', {name: nn}, (Http) => {
                if(Http.responseText == '__error1'){
                    alert('Name not found. Website Error.');
                    userId = undefined;
                }else if(Http.responseText == '__error2'){
                    alert('The room is full. You cannot register.');
                    userId = undefined;
                }else if(Http.responseText == '__error3'){
                    alert('Nickname already in use. Please select another nickname.');
                    userId = undefined;
                }else{
                    $('#regisButton').hide();
                    $('#nntxt').prop('disabled', true);
                    userId = Http.responseText;
                }
            });
        };
        var userRole = undefined;
        var userRoleNumber = -1;
        var curPeriod = 'none';
        var description = '';
        const fetchCard = () => {
            db.collection('settings').doc('settings').get().then((doc) => {
                curPeriod = doc.data().currentPeriod;
                if(curPeriod == 'none'){
                    $('#periodSpan').html('not selected yet');
                }else{
                    $('#periodSpan').html(curPeriod);
                }
            }).then(() => {
                if(userId){
                    callFunction('getUserRole', {uid: userId}, (Http) => {
                        userRoleNumber = Http.responseText;
                        db.collection('periods').where('name','==',curPeriod).get().then((querySnapshot) => {
                            querySnapshot.forEach((doc) => {
                                doc.ref.collection('roles').where('index','==',userRoleNumber).get().then((qrs) => {
                                    qrs.forEach((d) => {
                                        userRole = d.data().role;
                                        description = d.data().description;
                                        $('#roleSpan').html(userRole);
                                        $('#descSpan').html(description);
                                    });
                                });
                            });
                        });
                    });
                }else{
                    userRoleNumber = -1;
                    userRole = undefined;
                    $('#roleSpan').html('not selected yet');
                    $('#descSpan').html('not found');
                }
            });
        }
        $(document).ready(() => {
            $('#warndiv').hide();
            $('#carddiv').hide();
            $('#prepdiv').hide();
            db.collection('settings').doc('settings').onSnapshot((doc) => {
                if(doc.data().gameReady){
                    $('#prepdiv').hide();
                    if(userId){
                        fetchCard();
                        $('#carddiv').show();
                    }else{
                        $('#warndiv').show();
                    }
                }else{
                    $('#warndiv').hide();
                    $('#carddiv').hide();
                    $('#prepdiv').show();
                }
            });
        })
        </script>
    </head>
    <body>
        Hello, world!
        <div id="prepdiv">
            Enter the game...
            <input type="text" placeholder="Nickname" id="nntxt">
            <button id="regisButton" onclick=registerUser()>Go</button>
        </div>
        <div id="carddiv">
            <p>The period is: <span id="periodSpan"></span></p>
            <p>Your role is: <span id="roleSpan"></span></p>
            <p>Description: <span id="descSpan"></span></p>
        </div>
        <div id="warndiv">
            User not registered... <br>
            Please wait until the round ends first.
        </div>
    </body>
</html>
